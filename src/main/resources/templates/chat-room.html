<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en" layout:decorate="~{layouts/basic}">

<body onload="connect()">
<div layout:fragment="header">
  <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #666666; height: 10vh;">
    <!--        <div sec:authorize="isAuthenticated()">-->
    <a class="navbar-brand" href="#">[[${chatroom.title}]]</a>

    <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
      <ul class="navbar-nav mr-auto mt-2 mt-lg-0"></ul>
      <div class="form-inline my-2 my-lg-0">
        <a class="nav-link text-white" onclick="openRoomDetail()">방 정보</a>
        <!-- 방 정보 모달-->
        <div class="modal fade" id="roomDetailModal" tabindex="-1"
             aria-labelledby="roomDetailModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content pl-3 pr-3 pt-2 pb-2">
              <div class="modal-header">
                <h3 class="modal-title fs-5" id="roomDetailModalLabel">방 정보</h3>
                <!--  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
              </div>
              <div class="modal-body" th:object="${chatroom}">
                <form method="post" action="#">

                  <div class="row mt-3">
                    <p class="room-info-item-title col-3 mb-0">방 제목</p>
                    <input type="text" class="form-control room-info-item-input col-7" id="room-title" name="room-name"
                           th:value="${chatroom.title}">
                  </div>
                  <div class="row mt-3">
                    <p class="room-info-item-title col-3 mb-0">공개 여부</p>

                      <input type="button" class="form-control" id="room-close" name="room-close"
                             value="공개방"/>
                      <input type="button" class="form-control ml-2" id="room-open" name="room-open"
                             value="비밀방">
                  </div>
                  <div class="row mt-3" th:if="${chatroom.getPassword() != null}">
                    <p class="room-info-item-title col-3 mb-0">비밀번호</p>
                      <input type="text" class="form-control" id="room-password"
                             name="room-password" th:value="${chatroom.getPassword()}">
                  </div>
                  <div class="row mt-3">
                    <p class="room-info-item-title col-3 mb-0">인원 수</p>
                      <input type="text" class="form-control" id="room-capacity"
                             name="room-capacity" th:value="${chatroom.getCapacity()}">
                  </div>
                  <div class="row mt-3">
                    <p class="room-info-item-title col-3 mb-0">초대 코드</p>
                      <p class="form-control" id="room-invite" name="room-invite"></p>
                  </div>

                  <!-- 공유하기-->
                  <div class="row mb-3 mt-3">
                    <div class="col mx-auto">
                      <div class="sns">
                        <a href="#n" id="btnKakao" onclick="fn_sendFB('kakaotalk');return false;"
                           class="kakaotalk" target="_self"
                           title="카카오톡 새창열림"><span class="skip">카카오톡</span></a>
                        <a href="#n" onclick="handleCopyClipBoard();return false;" th:field="*{id}"
                           class="clipboard" target="_self"
                           title="클립보드 복사"><span class="skip">복사하기</span></a>
                        <!--<img id="preview"  alt="Preview" class="rounded-circle shadow" width="200px" height="200px">-->
                      </div>
                    </div>
                  </div>

                  <div class="row mt-4" style="margin-left: 150px;">
                    <div>
                      <button class="btn btn-secondary" type="submit">닫기</button>
                    </div>
                    <div class="ml-2">
                      <button class="btn btn-primary" type="submit">저장</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- 모달 끝 -->
        <div class="nav-item">
          <a class="nav-link text-white" onclick=gameStart()>게임시작</a>
          <a class="nav-link text-white" href="#"
             th:if="${chatroom.state.getValue() == T(com.springles.domain.constants.ChatRoomCode).PLAYING.getValue()}">내
            직업 설명</a>
        </div>
        <div class="nav-item">
          <a class="nav-link text-white" href="#">게임룰</a>
        </div>
        <div class="nav-item">
          <a class="nav-link text-white" href="http://localhost:8080/v1/index" onclick="">나가기</a>
        </div>
      </div>
    </div>
  </nav>
</div>

<div layout:fragment="content">

  <div class="row" style="border-radius: 10px;
    border: solid 1px silver;
    margin: 4vw;
    padding: 0;
    height: 80vh">
    <div class="col-3" style="height:100%; background-color: gray; padding:20px">
      <!---------------참여인원 / 정원 -------------------->
      <h3>참여자</h3>
      <span id="gamePlayer"></span>/
      <span id="gameCapacity"></span>
      <div id="playerList">
        <!--------------참여자 목록 ------------------------>
        <!--<div th:each="player : ${players}">
          <div th:text="${player.getMemberId()}"></div>
          <div th:text="${player.getRole()}"></div>
        </div>-->
      </div>
<!--            투표 테스트를 위한 임시 버튼-->
      <div>
        <form class="container row" id="vote-form">
          <select id="vote-select" class="form-select" aria-label="Default select example">
            <option selected>Open this select menu</option>
            <option value="1">One</option>
            <option value="2">Two</option>
            <option value="3">Three</option>
          </select>
          <button id="submit-vote" class="col-1 btn btn-primary" style="margin: 0 0 4px; width:75px" type="submit">투표하기
          </button>
        </form>
      </div>

            <form class="container row" id="vote-test">
                <input class="chat_input_ui col-11" style="margin:0;" type="text" id="vote" placeholder="vote"/>
                <button class="col-1 btn btn-primary" style="margin: 0 0 4px; width:75px" type="submit">투표 시작
                </button>
            </form>
    </div>
    <!------------------- 채팅----------------------------------------------------------------------------------->
    <div class="col-9" style="padding:0; height:80%">
      <!----------채팅 화면 스크롤 ----------------->
      <div id="conversationDiv">
        <div class="chat_ui">
          <a href="/chat"></a>
          <p id="response"></p>
        </div>
        <!---------채팅 입력 input ----------------->
        <form class="container row" id="message-form">
          <input class="chat_input_ui col-11" style="margin:0;" type="text" id="message"
                 placeholder="Write a message..."/>
          <button class="col-1 btn btn-primary" style="margin: 0 0 4px; width:75px" type="submit">
            보내기
          </button>
        </form>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
  <script src="/js/stomp.js"></script>
  <script type="text/javascript">
    let stompClient = null;
    let pathname = window.location.pathname;
    let roomId = parseInt(pathname.split("/")[2]);
    let nickname = decodeURI(pathname.split("/")[3]);

    function getRoomName() {
      fetch(`/v1/chatRooms/${roomId}`).then((response) => {
        response.json().then((responseBody) => {
          console.log(responseBody)
          document.getElementById('gameCapacity').innerHTML = responseBody.capacity;
        })
      });
    }

    function connect() {
      getRoomName();
      const socket = new WebSocket('ws://localhost:8080/chatting');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        // 게임 참여 메시지 전송
        stompClient.send(`/pub/gameJoin/${roomId}`)

        // 전체 채팅 URL 구독
        stompClient.subscribe(`/sub/chat/${roomId}`, (message) => {
          const body = JSON.parse(message.body)
          console.log("전체 메시지: ")
          receiveMessage(body);
        });

        // 채팅방 목록 URL 구독
        stompClient.subscribe(`/sub/chat/${roomId}/playerList`, function (message) {
          updatePlayerList(message)
          updateVoteList(message)
        })

        // 죽을 사람 후보
        stompClient.subscribe(`/sub/chat/${roomId}/deadPlayer`, function (message) {
          updateDeadPlayer(message)
        })


        // 개인 채팅 URL 구독
        stompClient.subscribe(`/sub/chat/${roomId}/${nickname}`, (message) => {
          const body = JSON.parse(message.body)
          console.log("개인 메시지: " + body)
          receiveMessage(body);
        })

        // 게임 시작 시 역할 부여 URL 구독
        stompClient.subscribe(`/sub/chat/${roomId}/gameRole/${nickname}`, (message => {
          const body = JSON.parse(message.body)
          console.log("역할 설명 메시지: " + body)
          stompClient.subscribe(`/sub/chat/${roomId}/${body.gameRole}`) // 직업 url
          stompClient.unsubscribe(`/sub/chat/${roomId}/playerRole/${nickname}`)
          receiveMessage(body)
        }))

      });
    }

    // 브라우저 변동 시 게임 나가기
    // 새로고침시 나갔다가 들어온 것으로 간주
    window.addEventListener('beforeunload', (event) => {
      event.preventDefault();
      stompClient.send(`/pub/gameExit/${roomId}`)
    });

    function updatePlayerList(message) {
      const list = document.getElementById('playerList');
      list.innerHTML = ""
      let i = 0
      for (const player of JSON.parse(message.body)) {
        const li = document.createElement('li');
        li.appendChild(document.createTextNode(
            "[" + player.memberName + "]"
        ))
        i++;
        list.appendChild(li)
      }
      document.getElementById('gamePlayer').innerText = i;
    }

    function updateVoteList(message) {
      const list = document.getElementById('vote-select');
      list.innerHTML = "";
      let i = 0
      for (const player of JSON.parse(message.body)) {
        const option = document.createElement('option');
        option.value = player.memberId;
        option.text = player.memberName;
        list.appendChild(option);
        i++;
      }
    }

    function updateDeadPlayer(message) {
      const deadPlayer = document.getElementById("vote-form");
      deadPlayer.innerHTML = "";
      const player = JSON.parse(message.body)
      console.log(player.memberName);
      // 찬성 버튼 생성
      const approveButton = document.createElement("button");
      approveButton.textContent = "찬성"; // 버튼 텍스트 설정
      approveButton.addEventListener("click", () => {
        // 찬성 버튼이 클릭되었을 때 실행될 코드 작성
        alert("찬성했습니다!");
        const message = JSON.stringify({
          'phase': 'DAY_ELIMINATE',
          'vote': player.memberId
        });
        console.log(message);
        stompClient.send(`/pub/chat/${roomId}/vote`, {
                  "Authorization": getCookie("accessToken")
                },
                message);
      });

      // 반대 버튼 생성
      const opposeButton = document.createElement("button");
      opposeButton.textContent = "반대"; // 버튼 텍스트 설정
      opposeButton.addEventListener("click", () => {
        // 반대 버튼이 클릭되었을 때 실행될 코드 작성
        alert("반대했습니다!");
        const message = JSON.stringify({
          'phase': 'DAY_ELIMINATE'
        });
        console.log(message);
        stompClient.send(`/pub/chat/${roomId}/vote`, {
                  "Authorization": getCookie("accessToken")
                },
                message);

      });

      // 찬성과 반대 버튼을 vote-form 요소에 추가
      deadPlayer.appendChild(approveButton);
      deadPlayer.appendChild(opposeButton);
    }

    function gameStart() {
      stompClient.send(`/pub/gameStart/${roomId}`)
    }

    function gameExit() {
      stompClient.send(`/pub/gameExit/${roomId}`)
      stompClient.disconnect();
      location.href = '/v1/index';
    }

    function receiveMessage(messageOutput) {
      const response = document.getElementById('response');
      console.log(response)
      const p = document.createElement('p');
      p.style.wordWrap = 'break-word';
      p.appendChild(document.createTextNode(
          " (" + messageOutput.time + ") "
          + messageOutput.sender
          + ": "
          + messageOutput.message));
      response.appendChild(p);
    }
// 투표 테스트를 위한 임시 코드
        document.getElementById("vote-test").addEventListener("submit", (event) => {
            event.preventDefault()
            stompClient.send(`/pub/chat/${roomId}/dayStart`, {
                "Authorization": getCookie("accessToken")
            });
            // /pub/chat/{roomId}/start

        })

    // 투표 제출이 되는지
    document.getElementById("vote-form").addEventListener("submit", (event) => {
      event.preventDefault()

      const list = document.getElementById('vote-select');
      const selectedIndex = list.selectedIndex;
      const selectedOption = list.options[selectedIndex];
      const selectedValue = selectedOption.value;
      const selectedText = selectedOption.text;
      alert(selectedText + "님을 투표했습니다!");
      console.log(selectedValue);
      const message = JSON.stringify({
        'phase': 'DAY_VOTE',
        'vote': selectedValue
      });
      console.log(message);
      stompClient.send(`/pub/chat/${roomId}/vote`, {
                "Authorization": getCookie("accessToken")
              },
              message);
    })

    document.getElementById("message-form").addEventListener("submit", (event) => {
      event.preventDefault()
      const messageInput = document.getElementById('message');
      const message = messageInput.value
      stompClient.send(`/pub/chat/${roomId}`, {
        "Authorization": getCookie("accessToken")
      }, message);
      messageInput.value = null
    })

    function openRoomDetail() {
      $('#roomDetailModal').modal('show'); // 모달 열기
    }

    const snsTitle = "챗피아에서 게임하기";
    const thisUrl = window.location.href;
    console.log("thisUrl", thisUrl)
    const handleCopyClipBoard = async () => {
      try {
        await navigator.clipboard.writeText(thisUrl);
        alert('클립보드에 링크가 복사되었습니다.');
      } catch (e) {
        alert('복사에 실패하였습니다');
      }
    };

    function getCookie(cookieName) {
      var name = cookieName + "=";
      var decodedCookie = decodeURIComponent(document.cookie);
      var cookieArray = decodedCookie.split(';');

      for (var i = 0; i < cookieArray.length; i++) {
        var cookie = cookieArray[i];
        while (cookie.charAt(0) === ' ') {
          cookie = cookie.substring(1);
        }
        if (cookie.indexOf(name) === 0) {
          return cookie.substring(name.length, cookie.length);
        }
      }
      return "";
    }

    function fn_sendFB(sns) {

      <!-- 카카오  -->
      if (sns == 'kakaotalk') {
        // 사용할 앱의 JavaScript 키 설정
        Kakao.init('1f068199be43767b197138dfc91f1cb6');

        // 카카오링크 버튼 생성
        Kakao.Link.createDefaultButton({
          container: '#btnKakao', // HTML에서 작성한 ID값
          objectType: 'feed',
          content: {
            title: snsTitle, // 보여질 제목
            description: snsTitle, // 보여질 설명
            imageUrl: thisUrl, // 카카오공유하기 시 썸네일 이미지 경로
            link: { //  카카오공유하기 시 클릭 후 이동 경로
              mobileWebUrl: thisUrl,
              webUrl: thisUrl
            }
          }
        });
      }
    }

  </script>
</div>
</body>
</html>