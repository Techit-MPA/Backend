<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="en" layout:decorate="~{layouts/basic}">

<div layout:fragment="content">
    <!------------navigation ---------------------->
<!--    <div class="nav-container" >-->
<!--        <div class="nav-left">-->
<!--            <p class="nav" aria-current="page" href="#">방 제목입니다</p>-->
<!--        </div>-->
<!--        <div class="nav-left">-->
<!--            <a class="nav-link active" aria-current="page" onclick="openRoomDetail()">!!</a>-->
<!--        </div>-->
<!--        <div class="nav-right">-->
<!--            <ul class="nav justify-content-end">-->
<!--                <li class="nav-item">-->
<!--                    <a class="nav-link active" aria-current="page" href="#">게임시작</a>-->
<!--                </li>-->
<!--                <li class="nav-item">-->
<!--                    <a class="nav-link" href="#">게임룰</a>-->
<!--                </li>-->
<!--                <li class="nav-item">-->
<!--                    <a class="nav-link" href="#">나가기</a>-->
<!--                </li>-->
<!--            </ul>-->
<!--        </div>-->
<!--    </div>-->

    <div class="row" style="border-radius: 10px;
    border: solid 1px silver;
    margin: 4vw;
    padding: 0;
    height: 80vh">
        <div class="col-3" style="height:100%; background-color: gray; padding:20px">
            <!---------------참여인원 / 정원 -------------------->
            <h3>참여자</h3>
            <span th:text="${chatroom.getHead()}"></span>/<span th:text="${chatroom.getCapacity()}"></span>
            <div>
                <!--------------참여자 목록 ------------------------>
                <div>사람 이름이 여기 나와야하눈뎅,,</div>
                <div th:each="player : ${players}">
                    <div th:text="${player.getMemberId()}"></div>
                    <div th:text="${player.getRole()}"></div>
                </div>
            </div>
        </div>
        <!------------------- 채팅----------------------------------------------------------------------------------->
        <div class="col-9" style="padding:0; height:80%">
            <!----------채팅 화면 스크롤 ----------------->
            <div id="conversationDiv">
                <div class="chat_ui">
                    <a href="/chat"></a>
                    <p id="response"></p>
                </div>
            <!---------채팅 입력 input ----------------->
                <form class="container row" id="message-form">
                    <input class="chat_input_ui col-11" style="margin:0;" type="text" id="message"/>
                    <button class="col-1 btn btn-primary" style="margin: 0 0 4px; width:75px" type="submit">보내기</button>
                </form>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="/js/stomp.js"></script>
<script type="text/javascript">

    window.onload = function () {
        connect();
    };

    let stompClient = null;
    const pathname = window.location.pathname;
    const roomId = parseInt(pathname.split("/")[2]);
    const nickname = decodeURI(pathname.split("/")[3]);

    function getRoomName() {
        fetch(`/chat/rooms/${roomId}/name`).then((response) => {
            response.json().then((responseBody) => {
                console.log(responseBody);
                document.getElementById('room-name').innerHTML = responseBody.roomName;
            })
        });
    }

    function connect() {
        getRoomName();
        // 최초의 연결을 위한 URL은 동일하게 ws://localhost:8080/chatting 으로
        const socket = new WebSocket('ws://localhost:8080/chatting');
        // Stomp.over() 를 사용해 STOMP 통신을 할것이라 지정
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            // subscribe 메소드를 통해 /topic/${roomId} 에 구독했음을 확인
            // roomId 의 경우 어떤 경로로 들어왔는지에 따라 바뀌는 동작이며, 후에 서버에서 메시지를 전달할때 클라이언트를 구분하기 위한 URL의 역할
            // 연결을 위한 엔드포인트는 ws://localhost:8080/chatting 하나로 유지하면서, 연결된 사용자들을 /topic 이라고 하는 경로를 통해 다시 구분
            stompClient.subscribe(`/topic/${roomId}`, function(message) {
                receiveMessage(JSON.parse(message.body));
            });
        });
    }

    function receiveMessage(messageOutput) {
        const response = document.getElementById('response');
        const p = document.createElement('p');
        p.style.wordWrap = 'break-word';
        p.appendChild(document.createTextNode(messageOutput.sender + ": "
            + messageOutput.message + " (" + messageOutput.time + ")"));
        response.appendChild(p);
    }

    document.getElementById("message-form").addEventListener("submit", (event) => {
        event.preventDefault()
        const messageInput = document.getElementById('message');
        const message = messageInput.value
        // 요청을 보내는 위치는 Configuration 의 setApplicationDestinationPrefixes 와 MessageMapping 의 값을 합쳐서 활용
        stompClient.send("/app/chat", {
                "Authorization": "Bearer Token_here"
            },
            JSON.stringify({
                'roomId': roomId,
                'sender': nickname,
                'message': message
            }));
        messageInput.value = null
    })
    function openRoomDetail() {

        var _width = '650';
        var _height = '380';

        // 팝업을 가운데 위치시키기 위해 아래와 같이 값 구하기
        var _left = Math.ceil(( window.screen.width - _width )/2);
        var _top = Math.ceil(( window.screen.height - _height )/2);

        var roomUrl = `/chat/${roomId}/detail`;

        window.open(roomUrl, 'popup-test', 'width='+ _width +', height='+ _height +', left=' + _left + ', top='+ _top );
    }

</script>
</div>
</html>